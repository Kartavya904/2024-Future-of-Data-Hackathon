@page
@model FinVest.Pages.FinancesModel

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finances - @Model.Username</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        body {
            background-color: #122953;
            font-family: 'Poppins', sans-serif;
            color: #f0f0f0;
        }

        .content {
            margin-top: 20px;
        }

        .content h2 {
            color: #76c7c0;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: #2A2A6A;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .card h3 {
            color: #76c7c0;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card h3 i {
            margin-right: 10px;
            color: #f0f0f0;
        }

        .card p {
            margin-bottom: 0;
            color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container content">
        <h2>Your Profile Information</h2>
        <div class="profile-info">
            <div class="card">
                <h3><i class="bi bi-person"></i>Username:</h3>
                <p>@Model.Username</p>
            </div>

            <div class="card">
                <h3><i class="bi bi-currency-dollar"></i>Preferred Currency:</h3>
                <p>@Model.CurrencyMultiplier</p>
            </div>

            <div class="card">
                <h3><i class="bi bi-cash-stack"></i>Annual Income:</h3>
                <p>@Model.AnnualIncome</p>
            </div>

            <div class="card">
                <h3><i class="bi bi-exclamation-triangle"></i>Risk Tolerance:</h3>
                <p>@Model.RiskTolerance</p>
            </div>

            <div class="card">
                <h3><i class="bi bi-graph-up"></i>Investment Experience:</h3>
                <p>@Model.InvestmentExperience</p>
            </div>

            <div class="card">
                <h3><i class="bi bi-bullseye"></i>Investment Goals:</h3>
                <p>@Model.InvestmentGoals</p>
            </div>
        </div>

        @* <p>Username: user_good<br>Password: pass_good<br>If prompted for 2FA, select Mobile phone ending 1111.<br>Code: 1234</p> *@

        <form id="plaidForm">
            @Html.AntiForgeryToken()
        </form>
        <button id="linkButton">Connect your bank</button>
    </div>

    <div class="transaction-history">
        <h2>Transaction History</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var transaction in Model.TransactionHistory)
                {
                    <tr>
                        <td>@transaction.TransactionId</td>
                        <td>@transaction.TransactionDate.ToString("MM/dd/yyyy")</td>
                        <td>@transaction.Description</td>
                        <td>@transaction.Category</td>
                        <td>@transaction.Amount.ToString("C")</td>
                        <td>@transaction.RunningBalance.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>


    <script type="text/javascript">
        var linkToken = "@Model.LinkToken";

        var handler = Plaid.create({
            token: linkToken,
            onSuccess: function(public_token, metadata) {
                // Get the anti-forgery token from the form
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                // Send the public_token to the server to exchange for an access token
                fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({ publicToken: public_token })
                })
                .then(response => response.text())
                .then(data => {
                    // Reload the page to display the account information
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            },
            onExit: function(err, metadata) {
                if (err != null) {
                    console.error(err);
                }
            },
            onEvent: function(eventName, metadata) {
                console.log(eventName, metadata);
            }
        });

        document.getElementById('linkButton').onclick = function() {
            handler.open();
        };
    </script>

    @if (Model.Accounts != null)
    {
        <h2>Account Information</h2>
        <table border="1">
            <tr>
                <th>Name</th>
                <th>Account Number</th>
                <th>Routing Number</th>
                <th>Type</th>
            </tr>
            @foreach (var account in Model.Accounts)
            {
                <tr>
                    <td>@account["name"]</td>
                    <td>@account["account_id"]</td>
                    <td>@account["routing"]</td>
                    <td>@account["type"]</td>
                </tr>
            }
        </table>
    }

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
